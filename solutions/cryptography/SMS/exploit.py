#!/usr/bin/env python2

import requests
import cryptanalib
from Crypto.PublicKey import RSA
from binascii import hexlify, unhexlify

URL = "http://sms.ctf.cuctf.io:8100"

r = requests.get(
    URL+"/read/0",
    headers={'Content-type': 'application/json'}
)
ciphertext = unhexlify(r.json()['ciphertext'])

r = requests.get(
    URL+"/keys/1",
    headers={'Content-type': 'application/json'}
)
key = RSA.importKey(r.json()['Key'])

def oracle(ciphertext):
    json_data = {
      "to_user": {
        "user_id": 0,
        "username": "Alice"
      },
      "from_user": {
        "user_id": 1,
        "username": "Bob"
      },
      "ciphertext": hexlify(ciphertext)
    }
    r = requests.post(
        URL+"/send",
        headers={'Content-type': 'application/json'},
        json=json_data
    )
    return "Failure" not in r.json()

decrypted = cryptanalib.bb98_padding_oracle(
    ciphertext,
    oracle,
    key.e,
    key.n,
    verbose=True,
    debug=True
)

print(decrypted)
