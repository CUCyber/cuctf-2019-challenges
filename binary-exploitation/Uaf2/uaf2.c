#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <sys/socket.h>
#include <resolv.h>
#include <arpa/inet.h>
#include <errno.h>
#include <string.h>
#include <unistd.h>

#define MAX_INDEX 5

char flag[0x20];

int current_chunk = 0;
char **strchunks[MAX_INDEX];

void quit(void){
    exit(0);
}

void display(void){
    if (current_chunk > -1){
        write(2, *strchunks[0], 32);
    } else {
        fprintf(stderr, "All chunks are free\n");
    }
}

void edit(void){
    if (current_chunk <= -1){
        return;
    }

    if (current_chunk == 0){
        fprintf(stderr, "You can't edit the first chunk\n");
        return;
    }

    fprintf(stderr, "Data: ");
    read(0, strchunks[current_chunk], 8);
}

void delete(void){
    if (current_chunk > -1){
        free(strchunks[current_chunk--]);
    }
}

void create(void){
    if (current_chunk < MAX_INDEX){
        if (current_chunk == -1)
            ++current_chunk;
        strchunks[++current_chunk] = malloc(0x50);
    }
}

void menu(void){
    fprintf(stderr, "Commands:\n");
    fprintf(stderr, "  Allocate\n");
    fprintf(stderr, "  Free\n");
    fprintf(stderr, "  Edit\n");
    fprintf(stderr, "  Print\n");
    fprintf(stderr, "  Quit\n");
}

void welcome(void){
    fprintf(stderr, "--------------------------------------\n");
    fprintf(stderr, "|    Welcome to the UAF Playground   |\n");
    fprintf(stderr, "--------------------------------------\n");
    fprintf(stderr, "The address of the flag is: %p\n\n", flag);
}

void initialize(void){
    FILE *fp = fopen("flag.txt", "r");
    if (!fp){
        fprintf(stderr, "Could not open flag file.\n");
        exit(-1);
    }
    fread(flag, 1, 32, fp);
    fclose(fp);

    strchunks[0] = malloc(0x50);
    *strchunks[0] = malloc(0x50);
    strncpy(*strchunks[0], "Hello from the first chunk!\n", 30);
}

int main(void){
	char buffer[0x20];

    initialize();

    welcome();

    do {
        menu();

        fprintf(stderr, "> ");
        fgets(buffer, 64, stdin);
        buffer[strcspn(buffer, "\r\n")] = 0;

        if (strcmp(buffer, "Allocate Last Chunk") == 0){
                create();
        } else if (strcmp(buffer, "Free Last Chunk") == 0){
                delete();
        } else if (strcmp(buffer, "Edit Last Chunk") == 0){
                edit();
        } else if (strcmp(buffer, "Print First Chunk") == 0){
                display();
        } else if (strcmp(buffer, "Quit") == 0){
                quit();
        }
    } while(1);

    return 0;
}
