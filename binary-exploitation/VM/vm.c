#include <stdio.h>
#include <fcntl.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <signal.h>

int pc = 0, val = 0;

void handler(int dummy){
    exit(-1);
}

void set_signal_handler(void){
    signal(SIGALRM, handler);
    alarm(5);
}

void shell(){
    printf("\n    Here's your shell    \n");
    printf("           ___             \n");
    printf("       .-'; ! ;''-.        \n");
    printf("     .'!  : | :  !`.       \n");
    printf("    /\\  ! : ! : !  /\\    \n");
    printf("   /\\ |  ! :|: !  | /\\   \n");
    printf("  (  \\ \\ ; :!: ; / /  )  \n");
    printf(" ( `. \\ | !:|:! | / .' )  \n");
    printf(" (`. \\ \\ \\!:|:!/ / / .')\n");
    printf("  \\ `.`.\\ |!|! |/,'.' /  \n");
    printf("   `._`.\\\\\\!!!// .'_.'  \n");
    printf("      `.`.\\\\|//.'.'      \n");
    printf("       |`._`n'_.'|         \n");
    printf("       |----^----|       \n\n");
}

static void test(void){
    char buffer[128];
    printf("test$ ");
    fflush(stdout);
    gets(buffer);
    printf("Entered command: %s\n", buffer);
}

static void interpret(void){
    static char code[256], result[256];
    static void *dispatch_table[] = {
        &&do_halt, &&do_inc, &&do_dec,
        &&do_mul, &&do_div, &&do_copy
    };
    #define DISPATCH() goto *dispatch_table[code[pc++]];

    printf("Raw VM Execution Mode\nVM> ");
    fflush(stdout);

    fgets(code, 256, stdin);

    DISPATCH();

    do_inc:
        val += 1;
        DISPATCH();

    do_dec:
        val--;
        DISPATCH();

    do_mul:
        val *= code[pc++];
        DISPATCH();

    do_div:
        val /= code[pc++];
        DISPATCH();

    do_copy:
        memset(result, 0, val);
        memcpy(result, code+pc, val);
        pc += val;
        DISPATCH();

    do_halt:
        printf(result);
        return;
}

int main(int argc, char **argv){
    set_signal_handler();

    setvbuf(stdin, 0, 2, 0);
    setvbuf(stdout, 0, 2, 0);

    char buffer[128];

    printf("Welcome to the VM Command Prompt.\n");
    printf("$ ");
    fflush(stdout);

    while(fgets(buffer, 128 , stdin)){
        if (strlen(buffer)+1 >= 128){
            /* Avoids buffer wrapping and it's funny */
            printf("\n*** stack smashing detected ***: <unknown> terminated\n");
            printf("Aborted (core dumped)\n");
            exit(-1);
        }

        buffer[strcspn(buffer, "\r\n")] = 0;

        /* Options list */
        if (strcmp(buffer, "?") == 0){
            printf("\nCommand List:\n");
            printf(" ?\t\tDisplays this help screen\n");
            printf(" shell\t\tGives a shell\n");
            printf(" test-prompt\tTest the prompt\n");
            printf(" quit\t\tExits the program\n");
        } else if (strcmp(buffer, "shell") == 0){
            shell();
        } else if (strcmp(buffer, "test-prompt") == 0){
            test();
        } else if (strcmp(buffer, "advanced") == 0){
            interpret();
        } else if ((strcmp(buffer, "quit") == 0)||
                    (strcmp(buffer, "q") == 0)||
                    (strcmp(buffer, "exit") == 0)){
            printf("Goodbye!\n");
            exit(0);
        } else if ((strcmp(buffer, "") != 0)) {
            printf("Invalid command.\n");
        }

        printf("$ ");
        fflush(stdout);
    }
}
