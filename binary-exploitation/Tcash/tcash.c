#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>

#define MAX_INDEX 5

struct ledger_entry {
    char *address;
    char *description;
    char *amount;
} entries[MAX_INDEX];

struct ledger_entry_meta {
    size_t addr_size;
    size_t desc_size;
    size_t amnt_size;
} entries_meta[MAX_INDEX];

void quit(void){
    char buffer[0x100];
    memset(buffer, 0, 0x100);
    fprintf(stderr, "Please state your reason for quitting: ");
    fgets(buffer, 0x100, stdin);
    exit(0);
}

void display(void){
    int index;

    fprintf(stderr, "Index: ");
    scanf(" %d", &index);

    if (index >= MAX_INDEX)
        return;

    fprintf(stderr, "Address: %s\n", entries[index].address);
    fprintf(stderr, "Description: %s\n", entries[index].description);
    fprintf(stderr, "Amount: %s\n", entries[index].amount);
}

void edit_desc(void){
    int index, len;
    char input[4], buffer[64];

    fprintf(stderr, "Index: ");
    if (fgets(input, 4, stdin) == NULL)
        return;

    index = strtoul(input, NULL, 10);
    if (index >= MAX_INDEX)
        return;

    fprintf(stderr, "Description: ");
    read(0, entries[index].description, entries_meta[index].desc_size);
}

void edit_amnt(void){
    int index, len;
    char input[4], buffer[64];

    fprintf(stderr, "Index: ");
    if (fgets(input, 4, stdin) == NULL)
        return;

    index = strtoul(input, NULL, 10);
    if (index >= MAX_INDEX)
        return;

    fprintf(stderr, "Amount: ");
    read(0, entries[index].amount, entries_meta[index].amnt_size);
}

void edit_addr(void){
    int index, len;
    char input[4], buffer[64];

    fprintf(stderr, "Index: ");
    if (fgets(input, 4, stdin) == NULL)
        return;

    index = strtoul(input, NULL, 10);
    if (index >= MAX_INDEX)
        return;

    fprintf(stderr, "Address: ");
    read(0, entries[index].address, entries_meta[index].addr_size);
}

void delete(void){
    int index;

    fprintf(stderr, "Index: ");
    scanf(" %d", &index);

    if (index >= MAX_INDEX)
        return;

    free(entries[index].address);
    free(entries[index].description);
    free(entries[index].amount);

    entries_meta[index].addr_size = 0;
    entries_meta[index].desc_size = 0;
    entries_meta[index].amnt_size = 0;
}

void create(void){
    int index, addr_size, desc_size, amnt_size;

    fprintf(stderr, "Index: ");
    scanf(" %d", &index);
    fprintf(stderr, "Address size: ");
    scanf(" %d", &addr_size);
    fprintf(stderr, "Description size: ");
    scanf(" %d", &desc_size);
    fprintf(stderr, "Amount size: ");
    scanf(" %d", &amnt_size);

    if (index >= MAX_INDEX)
        return;

    if (addr_size > 0){
        entries[index].address = malloc(addr_size);
        entries_meta[index].addr_size = addr_size;
    }

    if (desc_size > 0){
        entries[index].description = malloc(desc_size);
        entries_meta[index].desc_size = desc_size;
    }

    if (amnt_size > 0){
        entries[index].amount = malloc(amnt_size);
        entries_meta[index].amnt_size = amnt_size;
    }
}

void menu(void){
    fprintf(stderr, "Commands:\n");
    fprintf(stderr, "  Create Entry\n");
    fprintf(stderr, "  Delete Entry\n");
    fprintf(stderr, "  Edit Address\n");
    fprintf(stderr, "  Edit Description\n");
    fprintf(stderr, "  Edit Amount\n");
    fprintf(stderr, "  Display Entry\n");
    fprintf(stderr, "  Quit\n");
}

void welcome(void){
    fprintf(stderr, "--------------------------------------\n");
    fprintf(stderr, "| Welcome to the Tcash Ledger Wallet |\n");
    fprintf(stderr, "--------------------------------------\n");
}

int main(void){
    char buffer[64];

    welcome();

    do {
        menu();

        fprintf(stderr, "> ");
        fgets(buffer, 64, stdin);
        buffer[strcspn(buffer, "\r\n")] = 0;

        if (strcmp(buffer, "Create Entry") == 0){
                create();
        } else if (strcmp(buffer, "Delete Entry") == 0){
                delete();
        } else if (strcmp(buffer, "Edit Address") == 0){
                edit_addr();
        } else if (strcmp(buffer, "Edit Description") == 0){
                edit_desc();
        } else if (strcmp(buffer, "Edit Amount") == 0){
                edit_amnt();
        } else if (strcmp(buffer, "Display Entry") == 0){
                display();
        } else if (strcmp(buffer, "Quit") == 0){
                quit();
        }
    } while(1);

    return 0;
}
