#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>

#define BUFFERSIZE 32

struct func {
 void (*func)();
} *functionA = NULL, *functionB = NULL;

void printA(){
	printf("Hello, it is I, Function A!\n");
}

void printB(){
	system("cat flag.txt");
}

void printFuncA(){
	functionA->func();
}

void printFuncB(){
    printf("This function has been removed for security purposes.\n");
}

void setFuncA(){
	functionA->func = printA;
}

void setFuncB(){
	functionB->func = printB;
}

void freeFuncA(){
    free(functionA);
}

void freeFuncB(){
	free(functionB);
}

void allocateFuncB(){
	functionB = malloc(sizeof(struct func));
}

void allocateFuncA(){
	functionA = malloc(sizeof(struct func));
}

void cmdList(){
	printf("\nCommand List:\n");
	printf(" ?\t\tDisplays this help screen\n");
	printf(" allocate [A|B]\tAllocate memory for functionA or functionB\n");
	printf(" set [A|B]\tSet functionA or functionB to their respective functions\n");
	printf(" free [A|B]\tFree the memory of functionA or functionB\n");
	printf(" print [A|B]\tPrint functionA or functionB\n");
	printf(" quit\t\tExits the program\n\n");
	printf("Examples:\nallocate A\nallocate B\n\n");
}

void welcome(){
	printf("Welcome to Bob's Memory Management System (MMS) v1.0\n");
	printf("For a command list, enter ?\n");
	printf("$ ");
	fflush(stdout);
}

int main(){
	welcome();

	char buffer[BUFFERSIZE];

	while( fgets(buffer, BUFFERSIZE , stdin) ){
		if (strlen(buffer)+1 >= BUFFERSIZE){
			/* Avoids buffer wrapping and it's funny */
			printf("\n*** stack smashing detected ***: ./binary terminated\n");
			printf("Aborted (core dumped)\n");
			exit(-1);
		}

		buffer[strcspn(buffer, "\r\n")] = 0;

		/* Options list */
		if (strcmp(buffer, "?") == 0){
			cmdList();
		} else if (strcmp(buffer, "allocate A") == 0){
			allocateFuncA();
		} else if (strcmp(buffer, "free A") == 0){
			freeFuncA();
		} else if (strcmp(buffer, "set A") == 0){
			setFuncA();
		} else if (strcmp(buffer, "print A") == 0){
			printFuncA();
		} else if (strcmp(buffer, "allocate B") == 0){
			allocateFuncB();
		} else if (strcmp(buffer, "free B") == 0){
			freeFuncB();
		} else if (strcmp(buffer, "set B") == 0){
			setFuncB();
		} else if (strcmp(buffer, "print B") == 0){
			printFuncB();
		} else if ((strcmp(buffer, "quit") == 0)||
					(strcmp(buffer, "q") == 0)||
					(strcmp(buffer, "exit") == 0)){
			printf("Goodbye!\n");
			exit(0);
		} else if ((strcmp(buffer, "") != 0)) {
			printf("Invalid command.\n");
		}

		printf("$ ");
		fflush(stdout);
	}
}
