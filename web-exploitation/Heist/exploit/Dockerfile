# Stage 1
FROM ethereum/solc:0.5.10 as builder

# Stage 2
FROM node:8.16.1-alpine

ENV npm_config_prefix=/home/node/.npm-global \
    PATH="/home/node/.npm-global/bin:${PATH}" \
    NODE_PATH="/home/node/.npm-global/lib/node_modules"

COPY --from=builder /usr/bin/solc /usr/local/bin/

RUN apk add --update --no-cache \
    git \
    g++ \
    make \
    python

USER node
WORKDIR /home/node
RUN npm install -g \
    truffle \
    truffle-privatekey-provider \
    web3

ADD --chown=node:node . /home/node

RUN export CONTRACT_ABI=$(solc --abi ECorp.sol | tail -n 1); \
    sed -i "s/CONTRACT_ABI/${CONTRACT_ABI}/g" reset.js

ENTRYPOINT ["node", "reset.js"]
